# ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆæ©Ÿèƒ½ å®Œå…¨ã‚¬ã‚¤ãƒ‰

## ğŸ“– ç›®æ¬¡

- [æ¦‚è¦](#æ¦‚è¦)
- [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
- [åº—èˆ—ã®ä½œæˆã¨ç®¡ç†](#åº—èˆ—ã®ä½œæˆã¨ç®¡ç†)
- [åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã®ç®¡ç†](#åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã®ç®¡ç†)
- [APIå®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](#apiå®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³)
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
- [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

## æ¦‚è¦

### ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã¨ã¯

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯**è¤‡æ•°ã®åº—èˆ—ï¼ˆãƒ†ãƒŠãƒ³ãƒˆï¼‰ãŒç‹¬ç«‹ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã§ãã‚‹ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆè¨­è¨ˆ**ã§ã™ã€‚

#### ä¸»ãªç‰¹å¾´

| ç‰¹å¾´ | èª¬æ˜ |
|-----|------|
| **ãƒ‡ãƒ¼ã‚¿åˆ†é›¢** | å„åº—èˆ—ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»æ³¨æ–‡ãƒ»å£²ä¸ŠãŒç‰©ç†çš„ã«åˆ†é›¢ |
| **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡** | åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã¯è‡ªåº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ |
| **ãŠå®¢æ§˜ã®è‡ªç”±** | ãŠå®¢æ§˜ã¯å…¨åº—èˆ—ã‹ã‚‰è‡ªç”±ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠãƒ»æ³¨æ–‡å¯èƒ½ |
| **æ¨©é™ç®¡ç†** | owner / manager / staff ã®3æ®µéšã®æ¨©é™ãƒ¬ãƒ™ãƒ« |

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

```
ã€åº—èˆ—Aã€‘å¼å½“å±‹ã•ã‚“
â”œâ”€â”€ ã‚ªãƒ¼ãƒŠãƒ¼: ç”°ä¸­ã•ã‚“ï¼ˆå…¨æ¨©é™ï¼‰
â”œâ”€â”€ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼: ä½è—¤ã•ã‚“ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ãƒ»å£²ä¸Šé–²è¦§ï¼‰
â””â”€â”€ ã‚¹ã‚¿ãƒƒãƒ•: éˆ´æœ¨ã•ã‚“ï¼ˆæ³¨æ–‡ç¢ºèªã®ã¿ï¼‰

ã€åº—èˆ—Bã€‘ãŠå¯¿å¸å±‹ã•ã‚“
â”œâ”€â”€ ã‚ªãƒ¼ãƒŠãƒ¼: å±±ç”°ã•ã‚“ï¼ˆå…¨æ¨©é™ï¼‰
â””â”€â”€ ã‚¹ã‚¿ãƒƒãƒ•: é«˜æ©‹ã•ã‚“ï¼ˆæ³¨æ–‡ç¢ºèªã®ã¿ï¼‰

ã€ãŠå®¢æ§˜ã€‘
â”œâ”€â”€ å¤ªéƒã•ã‚“ â†’ åº—èˆ—Aã¨åº—èˆ—Bã‹ã‚‰æ³¨æ–‡å¯èƒ½
â””â”€â”€ èŠ±å­ã•ã‚“ â†’ å…¨åº—èˆ—ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–²è¦§ãƒ»æ³¨æ–‡å¯èƒ½
```

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STORES (åº—èˆ—)                  â”‚
â”‚  - id (PK)                                  â”‚
â”‚  - name, address, phone, email              â”‚
â”‚  - opening_time, closing_time               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚
    â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USERS â”‚ â”‚ MENUS â”‚ â”‚ ORDERS â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚store_â”‚ â”‚store_â”‚ â”‚store_  â”‚
â”‚  _id  â”‚ â”‚  _id  â”‚ â”‚  _id   â”‚ â† ã™ã¹ã¦store_idã§åˆ†é›¢
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JWTèªè¨¼         â”‚
â”‚  current_userå–å¾—â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  role='store'?   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ YES
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ current_user     â”‚
â”‚   .store_id å–å¾— â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DBã‚¯ã‚¨ãƒªã«store_idãƒ•ã‚£ãƒ«ã‚¿â”‚
â”‚  WHERE store_id = ?      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è‡ªåº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®ã¿ â”‚
â”‚  ã‚’è¿”å´          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åº—èˆ—ã®ä½œæˆã¨ç®¡ç†

### åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—1: Dockerç’°å¢ƒã‚’èµ·å‹•

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œ
cd bento-order-system

# Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
docker-compose up -d

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
docker-compose run --rm web alembic upgrade head
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥

```bash
# ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ‡ãƒ¢åº—èˆ—ã‚’ä½œæˆ
docker-compose exec web python scripts/init_data.py

# åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã¨åº—èˆ—ã‚’ç´ä»˜ã‘
docker-compose exec web python scripts/setup_store_data.py
```

**ä½œæˆã•ã‚Œã‚‹å†…å®¹:**
- ãƒ‡ãƒ¢åº—èˆ—ã€Œãƒ†ã‚¹ãƒˆå¼å½“å±‹ã€
- ãŠå®¢æ§˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: customer1
- åº—èˆ—ã‚ªãƒ¼ãƒŠãƒ¼: admin
- åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•: store1
- ã‚µãƒ³ãƒ—ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°ç¨®é¡

#### ã‚¹ãƒ†ãƒƒãƒ—3: å‹•ä½œç¢ºèª

```bash
# ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã‚‹
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin&password=admin@123"

# ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹
{
  "access_token": "eyJhbGciOiJIUzI1...",
  "token_type": "bearer",
  "role": "store"
}
```

### æ–°ã—ã„åº—èˆ—ã‚’ä½œæˆã™ã‚‹

#### æ–¹æ³•1: Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# create_new_store.py
from database import SessionLocal
from models import Store
from datetime import time

db = SessionLocal()

# æ–°åº—èˆ—ã‚’ä½œæˆ
new_store = Store(
    name="æ–°è¦ã‚ªãƒ¼ãƒ—ãƒ³å¼å½“å±‹",
    email="newstore@example.com",
    phone="03-1111-2222",
    address="æ±äº¬éƒ½æ¸‹è°·åŒºæ¸‹è°·1-2-3 æ¸‹è°·ãƒ“ãƒ«1F",
    opening_time=time(10, 0),   # 10:00
    closing_time=time(21, 0),   # 21:00
    description="æ–°é®®ãªé£Ÿæã‚’ä½¿ã£ãŸç¾å‘³ã—ã„å¼å½“ã‚’ã”æä¾›ã—ã¾ã™ã€‚",
    image_url="https://example.com/store-image.jpg",  # ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    is_active=True
)

db.add(new_store)
db.commit()
db.refresh(new_store)

print(f"âœ… åº—èˆ—ä½œæˆå®Œäº†")
print(f"   åº—èˆ—ID: {new_store.id}")
print(f"   åº—èˆ—å: {new_store.name}")
print(f"   ä½æ‰€: {new_store.address}")
```

å®Ÿè¡Œ:
```bash
docker-compose exec web python create_new_store.py
```

#### æ–¹æ³•2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›´æ¥æ“ä½œ

```bash
docker-compose exec db psql -U postgres -d bento_db

# SQLå®Ÿè¡Œ
INSERT INTO stores (name, email, phone_number, address, opening_time, closing_time, description, is_active)
VALUES (
  'æ–°è¦ã‚ªãƒ¼ãƒ—ãƒ³å¼å½“å±‹',
  'newstore@example.com',
  '03-1111-2222',
  'æ±äº¬éƒ½æ¸‹è°·åŒºæ¸‹è°·1-2-3',
  '10:00:00',
  '21:00:00',
  'æ–°é®®ãªé£Ÿæã‚’ä½¿ã£ãŸç¾å‘³ã—ã„å¼å½“ã‚’ã”æä¾›ã—ã¾ã™ã€‚',
  true
);

# ä½œæˆã—ãŸåº—èˆ—ã‚’ç¢ºèª
SELECT id, name, address FROM stores ORDER BY created_at DESC LIMIT 1;
```

### åº—èˆ—æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹

#### æ–¹æ³•1: åº—èˆ—ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«APIï¼ˆæ¨å¥¨ï¼‰

```bash
# åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
TOKEN=$(curl -s -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin&password=admin@123" \
  | jq -r '.access_token')

# åº—èˆ—æƒ…å ±ã‚’æ›´æ–°ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¨©é™ãŒå¿…è¦ï¼‰
curl -X PUT "http://localhost:8000/api/store/profile" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ã—ãŸå¼å½“å±‹",
    "phone": "03-9999-8888",
    "address": "æ±äº¬éƒ½æ¸‹è°·åŒºæ–°ä½æ‰€2-3-4",
    "opening_time": "09:00:00",
    "closing_time": "22:00:00",
    "description": "ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¾ã—ãŸï¼æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤šæ•°ï¼",
    "image_url": "https://example.com/renewed-store.jpg"
  }'
```

#### æ–¹æ³•2: Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# update_store.py
from database import SessionLocal
from models import Store
from datetime import time

db = SessionLocal()

# æ›´æ–°ã—ãŸã„åº—èˆ—ã‚’å–å¾—
store = db.query(Store).filter(Store.id == 1).first()

if store:
    # æƒ…å ±ã‚’æ›´æ–°
    store.name = "ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ã—ãŸå¼å½“å±‹"
    store.phone_number = "03-9999-8888"
    store.address = "æ±äº¬éƒ½æ¸‹è°·åŒºæ–°ä½æ‰€2-3-4"
    store.opening_time = time(9, 0)
    store.closing_time = time(22, 0)
    store.description = "ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¾ã—ãŸï¼"
    
    db.commit()
    print(f"âœ… åº—èˆ—æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ: {store.name}")
else:
    print("âŒ åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
```

### åº—èˆ—ã®ä¸€è¦§ã‚’ç¢ºèªã™ã‚‹

```python
# list_all_stores.py
from database import SessionLocal
from models import Store

db = SessionLocal()
stores = db.query(Store).filter(Store.is_active == True).all()

print(f"ç™»éŒ²åº—èˆ—æ•°: {len(stores)}\n")
print("=" * 80)

for store in stores:
    print(f"åº—èˆ—ID: {store.id}")
    print(f"åº—èˆ—å: {store.name}")
    print(f"ä½æ‰€: {store.address}")
    print(f"é›»è©±: {store.phone_number}")
    print(f"ãƒ¡ãƒ¼ãƒ«: {store.email}")
    print(f"å–¶æ¥­æ™‚é–“: {store.opening_time} - {store.closing_time}")
    print(f"èª¬æ˜: {store.description or '(ãªã—)'}")
    print(f"çŠ¶æ…‹: {'å–¶æ¥­ä¸­' if store.is_active else 'ä¼‘æ¥­ä¸­'}")
    print(f"ä½œæˆæ—¥: {store.created_at}")
    print("-" * 80)

db.close()
```

## åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã®ç®¡ç†

### æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ã™ã‚‹

#### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ

```python
# create_staff.py
from database import SessionLocal
from models import User, Role, UserRole
from auth import get_password_hash

db = SessionLocal()

# æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
new_user = User(
    username="tanaka_staff",
    email="tanaka@example.com",
    hashed_password=get_password_hash("secure_password"),
    role="store",           # åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•
    full_name="ç”°ä¸­ å¤ªéƒ",
    store_id=1,             # æ‰€å±åº—èˆ—ID
    is_active=True
)

db.add(new_user)
db.commit()
db.refresh(new_user)

print(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå®Œäº†: {new_user.username} (ID: {new_user.id})")
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: è·ä½ã‚’å‰²ã‚Šå½“ã¦

```python
# assign_role.py
from database import SessionLocal
from models import User, Role, UserRole

db = SessionLocal()

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨è·ä½ã‚’å–å¾—
user = db.query(User).filter(User.username == "tanaka_staff").first()
role = db.query(Role).filter(Role.name == "staff").first()  # owner, manager, ã¾ãŸã¯ staff

# è·ä½ã‚’å‰²ã‚Šå½“ã¦
user_role = UserRole(
    user_id=user.id,
    role_id=role.id
)
db.add(user_role)
db.commit()

print(f"âœ… {user.username} ã« {role.name} è·ä½ã‚’å‰²ã‚Šå½“ã¦ã¾ã—ãŸ")
```

#### ä¸€æ‹¬å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# add_new_staff_complete.py
from database import SessionLocal
from models import User, Role, UserRole
from auth import get_password_hash

db = SessionLocal()

# è¨­å®š
USERNAME = "tanaka_staff"
EMAIL = "tanaka@example.com"
PASSWORD = "secure_password"
FULL_NAME = "ç”°ä¸­ å¤ªéƒ"
STORE_ID = 1
ROLE_NAME = "staff"  # owner, manager, ã¾ãŸã¯ staff

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
new_user = User(
    username=USERNAME,
    email=EMAIL,
    hashed_password=get_password_hash(PASSWORD),
    role="store",
    full_name=FULL_NAME,
    store_id=STORE_ID,
    is_active=True
)
db.add(new_user)
db.commit()
db.refresh(new_user)

# è·ä½å‰²ã‚Šå½“ã¦
role = db.query(Role).filter(Role.name == ROLE_NAME).first()
if not role:
    print(f"âŒ è·ä½ '{ROLE_NAME}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    exit(1)

user_role = UserRole(user_id=new_user.id, role_id=role.id)
db.add(user_role)
db.commit()

print(f"âœ… ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ å®Œäº†")
print(f"   ãƒ¦ãƒ¼ã‚¶ãƒ¼å: {new_user.username}")
print(f"   æ°å: {new_user.full_name}")
print(f"   åº—èˆ—ID: {new_user.store_id}")
print(f"   è·ä½: {ROLE_NAME}")
print(f"   ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: {PASSWORD}")
```

### æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åº—èˆ—ã«ç´ä»˜ã‘ã‚‹

```python
# assign_existing_user_to_store.py
from database import SessionLocal
from models import User, Role, UserRole

db = SessionLocal()

# æ—¢å­˜ã®ãŠå®¢æ§˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
user = db.query(User).filter(User.username == "customer1").first()

if not user:
    print("âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    exit(1)

# åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã«å¤‰æ›´
user.role = "store"
user.store_id = 1  # æ‰€å±åº—èˆ—ID

# è·ä½ã‚’å‰²ã‚Šå½“ã¦
staff_role = db.query(Role).filter(Role.name == "staff").first()
user_role = UserRole(user_id=user.id, role_id=staff_role.id)
db.add(user_role)

db.commit()

print(f"âœ… {user.username} ã‚’åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã«å¤‰æ›´ã—ã¾ã—ãŸ")
print(f"   åº—èˆ—ID: {user.store_id}")
print(f"   è·ä½: staff")
```

### ã‚¹ã‚¿ãƒƒãƒ•ã®è·ä½ã‚’å¤‰æ›´ã™ã‚‹

```python
# change_staff_role.py
from database import SessionLocal
from models import User, Role, UserRole

db = SessionLocal()

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
user = db.query(User).filter(User.username == "tanaka_staff").first()

# ç¾åœ¨ã®è·ä½ã‚’å‰Šé™¤
db.query(UserRole).filter(UserRole.user_id == user.id).delete()

# æ–°ã—ã„è·ä½ã‚’å‰²ã‚Šå½“ã¦
new_role = db.query(Role).filter(Role.name == "manager").first()  # staffã‹ã‚‰managerã«æ˜‡æ ¼
user_role = UserRole(user_id=user.id, role_id=new_role.id)
db.add(user_role)

db.commit()

print(f"âœ… {user.username} ã®è·ä½ã‚’ {new_role.name} ã«å¤‰æ›´ã—ã¾ã—ãŸ")
```

### ã‚¹ã‚¿ãƒƒãƒ•ã®ä¸€è¦§ã‚’ç¢ºèªã™ã‚‹

```python
# list_store_staff.py
from database import SessionLocal
from models import User, Role, UserRole
from sqlalchemy.orm import joinedload

db = SessionLocal()

# åº—èˆ—IDã‚’æŒ‡å®š
STORE_ID = 1

# åº—èˆ—ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å–å¾—
staff_users = db.query(User).filter(
    User.role == "store",
    User.store_id == STORE_ID
).options(joinedload(User.user_roles).joinedload(UserRole.role)).all()

print(f"åº—èˆ—ID {STORE_ID} ã®ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§\n")
print("=" * 80)

for user in staff_users:
    roles = [ur.role.name for ur in user.user_roles]
    print(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼å: {user.username}")
    print(f"æ°å: {user.full_name}")
    print(f"ãƒ¡ãƒ¼ãƒ«: {user.email}")
    print(f"è·ä½: {', '.join(roles) if roles else '(æœªå‰²ã‚Šå½“ã¦)'}")
    print(f"çŠ¶æ…‹: {'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' if user.is_active else 'ç„¡åŠ¹'}")
    print("-" * 80)
```

## APIå®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### å¿…é ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

æ–°ã—ã„åº—èˆ—å‘ã‘APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã‚’ã™ã¹ã¦æº€ãŸã—ã¦ãã ã•ã„ï¼š

- [ ] **1. store_idå­˜åœ¨ç¢ºèª**
- [ ] **2. ã™ã¹ã¦ã®DBã‚¯ã‚¨ãƒªã«store_idãƒ•ã‚£ãƒ«ã‚¿**
- [ ] **3. ãƒ‡ãƒ¼ã‚¿ä½œæˆæ™‚ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§store_idè¨­å®š**
- [ ] **4. å­˜åœ¨ã—ãªã„ãƒªã‚½ãƒ¼ã‚¹ã¯404ã‚’è¿”ã™**
- [ ] **5. ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã®ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ **

### å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³é›†

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§å–å¾—

```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from database import get_db
from models import User, Menu
from dependencies import require_role

router = APIRouter()

@router.get("/menus")
def get_menus(
    db: Session = Depends(get_db),
    current_user: User = Depends(require_role(['owner', 'manager', 'staff']))
):
    """ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§å–å¾—ï¼ˆè‡ªåº—èˆ—ã®ã¿ï¼‰"""
    # âœ… 1. store_idå­˜åœ¨ç¢ºèª
    if not current_user.store_id:
        raise HTTPException(
            status_code=400,
            detail="User is not associated with any store"
        )
    
    # âœ… 2. store_idã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    menus = db.query(Menu).filter(
        Menu.store_id == current_user.store_id
    ).all()
    
    return menus
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ

```python
@router.post("/menus")
def create_menu(
    menu: MenuCreate,  # Pydanticã‚¹ã‚­ãƒ¼ãƒï¼ˆstore_idã‚’å«ã¾ãªã„ï¼‰
    db: Session = Depends(get_db),
    current_user: User = Depends(require_role(['owner', 'manager']))
):
    """ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆï¼ˆè‡ªå‹•çš„ã«è‡ªåº—èˆ—ã«ç´ä»˜ã‘ï¼‰"""
    # âœ… 1. store_idå­˜åœ¨ç¢ºèª
    if not current_user.store_id:
        raise HTTPException(
            status_code=400,
            detail="User is not associated with any store"
        )
    
    # âœ… 3. ã‚µãƒ¼ãƒãƒ¼å´ã§store_idè¨­å®š
    db_menu = Menu(
        **menu.dict(),
        store_id=current_user.store_id  # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰å—ã‘å–ã‚‰ãªã„
    )
    
    db.add(db_menu)
    db.commit()
    db.refresh(db_menu)
    
    return db_menu
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ãƒªã‚½ãƒ¼ã‚¹æ›´æ–°

```python
@router.put("/menus/{menu_id}")
def update_menu(
    menu_id: int,
    menu: MenuUpdate,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_role(['owner', 'manager']))
):
    """ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°ï¼ˆè‡ªåº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰"""
    # âœ… 1. store_idå­˜åœ¨ç¢ºèª
    if not current_user.store_id:
        raise HTTPException(
            status_code=400,
            detail="User is not associated with any store"
        )
    
    # âœ… 2. store_idã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    db_menu = db.query(Menu).filter(
        Menu.id == menu_id,
        Menu.store_id == current_user.store_id  # å¿…é ˆ
    ).first()
    
    # âœ… 4. å­˜åœ¨ã—ãªã„å ´åˆã¯404
    if not db_menu:
        raise HTTPException(status_code=404, detail="Menu not found")
    
    # æ›´æ–°å‡¦ç†
    for key, value in menu.dict(exclude_unset=True).items():
        setattr(db_menu, key, value)
    
    db.commit()
    db.refresh(db_menu)
    
    return db_menu
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³4: ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤

```python
@router.delete("/menus/{menu_id}")
def delete_menu(
    menu_id: int,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_role(['owner']))  # ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿
):
    """ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‰Šé™¤ï¼ˆè‡ªåº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰"""
    # âœ… 1. store_idå­˜åœ¨ç¢ºèª
    if not current_user.store_id:
        raise HTTPException(
            status_code=400,
            detail="User is not associated with any store"
        )
    
    # âœ… 2. store_idã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    db_menu = db.query(Menu).filter(
        Menu.id == menu_id,
        Menu.store_id == current_user.store_id
    ).first()
    
    # âœ… 4. å­˜åœ¨ã—ãªã„å ´åˆã¯404
    if not db_menu:
        raise HTTPException(status_code=404, detail="Menu not found")
    
    db.delete(db_menu)
    db.commit()
    
    return {"message": "Menu deleted successfully"}
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³5: é›†è¨ˆã‚¯ã‚¨ãƒª

```python
from sqlalchemy import func

@router.get("/reports/sales")
def get_sales_report(
    start_date: str,
    end_date: str,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_role(['owner', 'manager']))
):
    """å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆå–å¾—ï¼ˆè‡ªåº—èˆ—ã®ã¿ï¼‰"""
    # âœ… 1. store_idå­˜åœ¨ç¢ºèª
    if not current_user.store_id:
        raise HTTPException(
            status_code=400,
            detail="User is not associated with any store"
        )
    
    # âœ… 2. ã™ã¹ã¦ã®é›†è¨ˆã‚¯ã‚¨ãƒªã«store_idãƒ•ã‚£ãƒ«ã‚¿
    
    # æ—¥åˆ¥å£²ä¸Š
    daily_sales = db.query(
        func.date(Order.ordered_at).label('date'),
        func.sum(Order.total_price).label('total')
    ).filter(
        Order.store_id == current_user.store_id,  # å¿…é ˆ
        Order.ordered_at >= start_date,
        Order.ordered_at <= end_date,
        Order.status != 'cancelled'
    ).group_by(func.date(Order.ordered_at)).all()
    
    # åˆè¨ˆå£²ä¸Š
    total_sales = db.query(
        func.sum(Order.total_price)
    ).filter(
        Order.store_id == current_user.store_id,  # å¿…é ˆ
        Order.ordered_at >= start_date,
        Order.ordered_at <= end_date,
        Order.status != 'cancelled'
    ).scalar() or 0
    
    # äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼
    popular_menus = db.query(
        Menu.name,
        func.count(Order.id).label('order_count')
    ).join(Order).filter(
        Order.store_id == current_user.store_id,  # å¿…é ˆ
        Order.ordered_at >= start_date,
        Order.ordered_at <= end_date,
        Order.status != 'cancelled'
    ).group_by(Menu.name).order_by(
        func.count(Order.id).desc()
    ).limit(10).all()
    
    return {
        "daily_sales": daily_sales,
        "total_sales": total_sales,
        "popular_menus": popular_menus
    }
```

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹

```python
# tests/test_menu_isolation.py
import pytest
from fastapi.testclient import TestClient

def test_store_a_cannot_access_store_b_menu(
    client: TestClient,
    auth_headers_store_a,  # åº—èˆ—Aã®ã‚¹ã‚¿ãƒƒãƒ•
    menu_store_b           # åº—èˆ—Bã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼
):
    """åº—èˆ—Aã®ã‚¹ã‚¿ãƒƒãƒ•ãŒåº—èˆ—Bã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨"""
    # âœ… 5. ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã®ãƒ†ã‚¹ãƒˆ
    
    # åº—èˆ—Bã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹
    response = client.get(
        f"/api/store/menus/{menu_store_b.id}",
        headers=auth_headers_store_a
    )
    
    # 404ãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆ403ã§ã¯ãªãï¼‰
    assert response.status_code == 404
    assert response.json()["detail"] == "Menu not found"

def test_menu_list_contains_only_own_store(
    client: TestClient,
    auth_headers_store_a,
    menu_store_a,
    menu_store_b
):
    """ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã«è‡ªåº—èˆ—ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã¿å«ã¾ã‚Œã‚‹ã“ã¨"""
    response = client.get(
        "/api/store/menus",
        headers=auth_headers_store_a
    )
    
    assert response.status_code == 200
    menus = response.json()
    
    # åº—èˆ—Aã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹
    menu_ids = [m["id"] for m in menus]
    assert menu_store_a.id in menu_ids
    
    # åº—èˆ—Bã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯å«ã¾ã‚Œã¦ã„ãªã„
    assert menu_store_b.id not in menu_ids
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ã™ã¹ã¦ã®åº—èˆ—å‘ã‘ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§èªè¨¼ã‚’è¦æ±‚
- [ ] ã™ã¹ã¦ã®DBã‚¯ã‚¨ãƒªã«`store_id`ãƒ•ã‚£ãƒ«ã‚¿ã‚’è¿½åŠ 
- [ ] ãƒ‡ãƒ¼ã‚¿ä½œæˆæ™‚ã¯`current_user.store_id`ã‚’ä½¿ç”¨ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰å—ã‘å–ã‚‰ãªã„ï¼‰
- [ ] å­˜åœ¨ã—ãªã„ãƒªã‚½ãƒ¼ã‚¹ã¯404ã‚’è¿”ã™ï¼ˆ403ã¯ä½¿ã‚ãªã„ï¼‰
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚ãªã„
- [ ] é›†è¨ˆã‚¯ã‚¨ãƒªã‚‚`store_id`ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- [ ] JOINã‚’ä½¿ã†å ´åˆã‚‚`store_id`ãƒ•ã‚£ãƒ«ã‚¿ã‚’å¿˜ã‚Œãªã„

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
# ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
docker-compose exec web pytest tests/test_store_isolation.py -v

# å…¨ãƒ†ã‚¹ãƒˆçµæœ
# âœ… test_store_a_cannot_get_store_b_order_status
# âœ… test_store_b_cannot_get_store_a_order_status
# âœ… test_order_list_contains_only_own_store_orders
# âœ… test_order_list_isolation_with_multiple_orders
# âœ… test_store_a_cannot_update_store_b_menu
# âœ… test_store_b_cannot_delete_store_a_menu
# âœ… test_menu_list_contains_only_own_store_menus
# âœ… test_created_menu_has_correct_store_id
# âœ… test_dashboard_shows_only_own_store_data
# âœ… test_sales_report_contains_only_own_store_data
# âœ… test_manager_cannot_access_other_store_data
# âœ… test_staff_cannot_access_other_store_data
# âœ… test_no_data_leakage_in_error_messages

# 13 passed, 0 failed âœ…
```

è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆ:
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ](SECURITY_TEST_REPORT_MULTI_TENANT.md)
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ](SECURITY_FIX_COMPLETE_REPORT.md)

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

#### Q1: åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ãŒãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ãŒã€APIãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

**ç—‡çŠ¶:**
```json
{
  "detail": "User is not associated with any store"
}
```

**åŸå› :** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®`store_id`ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•:**
```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®store_idã‚’ç¢ºèª
docker-compose exec db psql -U postgres -d bento_db -c \
  "SELECT id, username, role, store_id FROM users WHERE username='your_username';"

# store_idãŒNULLã®å ´åˆã€è¨­å®šã™ã‚‹
docker-compose exec web python -c "
from database import SessionLocal
from models import User
db = SessionLocal()
user = db.query(User).filter(User.username == 'your_username').first()
user.store_id = 1  # åº—èˆ—ID
db.commit()
print(f'âœ… {user.username} ã‚’åº—èˆ—ID {user.store_id} ã«ç´ä»˜ã‘ã¾ã—ãŸ')
"
```

#### Q2: åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã«è·ä½ï¼ˆroleï¼‰ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„

**ç—‡çŠ¶:**
```json
{
  "detail": "Insufficient permissions"
}
```

**åŸå› :** user_rolesãƒ†ãƒ¼ãƒ–ãƒ«ã«è·ä½ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•:**
```bash
# è·ä½ã‚’ç¢ºèª
docker-compose exec web python -c "
from database import SessionLocal
from models import User, Role, UserRole
db = SessionLocal()
user = db.query(User).filter(User.username == 'your_username').first()
roles = db.query(Role).join(UserRole).filter(UserRole.user_id == user.id).all()
print(f'ãƒ¦ãƒ¼ã‚¶ãƒ¼: {user.username}')
print(f'è·ä½: {[r.name for r in roles]}')
"

# è·ä½ã‚’å‰²ã‚Šå½“ã¦
docker-compose exec web python -c "
from database import SessionLocal
from models import User, Role, UserRole
db = SessionLocal()
user = db.query(User).filter(User.username == 'your_username').first()
role = db.query(Role).filter(Role.name == 'staff').first()
user_role = UserRole(user_id=user.id, role_id=role.id)
db.add(user_role)
db.commit()
print(f'âœ… {user.username} ã« {role.name} ã‚’å‰²ã‚Šå½“ã¦ã¾ã—ãŸ')
"
```

#### Q3: ä»–åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã—ã¾ã†ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ï¼‰

**ç—‡çŠ¶:** ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹

**åŸå› :** ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«`store_id`ãƒ•ã‚£ãƒ«ã‚¿ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•:**

1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦å•é¡Œç®‡æ‰€ã‚’ç‰¹å®š:
```bash
docker-compose exec web pytest tests/test_store_isolation.py -v
```

2. å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã«å¯¾å¿œã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª

3. `store_id`ãƒ•ã‚£ãƒ«ã‚¿ã‚’è¿½åŠ :
```python
# âŒ ä¿®æ­£å‰
orders = db.query(Order).all()

# âœ… ä¿®æ­£å¾Œ
orders = db.query(Order).filter(
    Order.store_id == current_user.store_id
).all()
```

4. ãƒ†ã‚¹ãƒˆã‚’å†å®Ÿè¡Œã—ã¦ç¢ºèª:
```bash
docker-compose exec web pytest tests/test_store_isolation.py -v
```

#### Q4: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆæ™‚ã«422ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

**ç—‡çŠ¶:**
```json
{
  "detail": [
    {
      "loc": ["body", "store_id"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

**åŸå› :** Pydanticã‚¹ã‚­ãƒ¼ãƒã«`store_id`ãŒå«ã¾ã‚Œã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•:**

schemas.pyã‚’ä¿®æ­£:
```python
# âŒ ä¿®æ­£å‰
class MenuCreate(BaseModel):
    name: str
    price: int
    description: Optional[str] = None
    store_id: int  # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæŒ‡å®šï¼ˆå±é™ºï¼‰

# âœ… ä¿®æ­£å¾Œ
class MenuCreate(BaseModel):
    name: str
    price: int
    description: Optional[str] = None
    # store_idã¯å‰Šé™¤ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•è¨­å®šï¼‰
```

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã‚µãƒ¼ãƒãƒ¼å´ã§è¨­å®š:
```python
db_menu = Menu(
    **menu.dict(),
    store_id=current_user.store_id  # ã‚µãƒ¼ãƒãƒ¼å´ã§è¨­å®š
)
```

#### Q5: å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆã«ä»–åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ãŒæ··åœ¨ã—ã¦ã„ã‚‹

**ç—‡çŠ¶:** å£²ä¸Šé‡‘é¡ãŒç•°å¸¸ã«å¤§ãã„

**åŸå› :** é›†è¨ˆã‚¯ã‚¨ãƒªã«`store_id`ãƒ•ã‚£ãƒ«ã‚¿ãŒæŠœã‘ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•:**

ã™ã¹ã¦ã®é›†è¨ˆã‚¯ã‚¨ãƒªã«`store_id`ãƒ•ã‚£ãƒ«ã‚¿ã‚’è¿½åŠ :
```python
# âŒ ä¿®æ­£å‰
total_sales = db.query(func.sum(Order.total_price)).filter(
    Order.ordered_at >= start_date,
    Order.ordered_at <= end_date
).scalar()

# âœ… ä¿®æ­£å¾Œ
total_sales = db.query(func.sum(Order.total_price)).filter(
    Order.store_id == current_user.store_id,  # è¿½åŠ 
    Order.ordered_at >= start_date,
    Order.ordered_at <= end_date
).scalar()
```

## å‚è€ƒè³‡æ–™

- [README.md](../README.md) - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®èª¬æ˜
- [ER_DIAGRAM.md](ER_DIAGRAM.md) - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆè©³ç´°
- [SECURITY_FIX_COMPLETE_REPORT.md](SECURITY_FIX_COMPLETE_REPORT.md) - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ãƒ¬ãƒãƒ¼ãƒˆ
- [SECURITY_TEST_REPORT_MULTI_TENANT.md](SECURITY_TEST_REPORT_MULTI_TENANT.md) - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆè©³ç´°

---

**ä½œæˆæ—¥:** 2025å¹´10æœˆ12æ—¥  
**æœ€çµ‚æ›´æ–°:** 2025å¹´10æœˆ12æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0
