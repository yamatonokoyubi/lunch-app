# Issue #90: メニュー画像アップロード機能

## 実装概要

画像URLの手入力を不要にし、画像ファイルを直接アップロードできる機能を提供します。ドラッグ＆ドロップやプレビューに対応した直感的なUIで、店舗スタッフの作業効率とUXを大幅に向上させます。

## 実装内容

### 1. バックエンド API

#### POST /api/store/menus/{menu_id}/image
メニュー画像をアップロードします。

**パラメータ:**
- `menu_id`: メニューID
- `file`: 画像ファイル (FormData)

**制限:**
- 対応形式: JPEG, PNG, GIF, WebP
- 最大サイズ: 2MB
- 古い画像は自動的に削除される

**レスポンス:**
```json
{
  "id": 1,
  "name": "唐揚げ弁当",
  "price": 500,
  "image_url": "/static/images/menus/123e4567-e89b-12d3-a456-426614174000.jpg",
  ...
}
```

#### DELETE /api/store/menus/{menu_id}/image
メニュー画像を削除します。

**パラメータ:**
- `menu_id`: メニューID

**レスポンス:**
```json
{
  "id": 1,
  "name": "唐揚げ弁当",
  "price": 500,
  "image_url": null,
  ...
}
```

### 2. フロントエンド機能

#### ドラッグ&ドロップエリア
- 画像ファイルをドラッグ&ドロップで選択可能
- ドラッグオーバー時の視覚的フィードバック
- ファイル選択ダイアログからも選択可能

#### プレビュー表示
- アップロード前の画像プレビュー
- ファイル名の表示
- 削除ボタンで画像を解除

#### バリデーション
- クライアント側でファイル形式をチェック
- ファイルサイズのチェック (2MB)
- エラーメッセージの表示

### 3. テストコード

`tests/test_menu_image_upload.py` に以下のテストを実装:

**正常系:**
- JPEG画像のアップロード
- PNG画像のアップロード
- 古い画像の置き換え
- 画像の削除

**異常系:**
- 無効なファイル形式
- ファイルサイズ超過
- 存在しないメニュー
- 未認証アクセス

## 動作確認手順

### 1. ログイン
```
URL: http://localhost:8000/login
ユーザー名: store1
パスワード: password123
```

### 2. メニュー管理画面へ移動
```
URL: http://localhost:8000/store/menus
```

### 3. メニュー追加/編集モーダルを開く
- 「➕ メニュー追加」ボタンをクリック
- または既存メニューの「✏️ 編集」ボタンをクリック

### 4. 画像アップロードをテスト

#### パターン1: ドラッグ&ドロップ
1. ローカルPCから画像ファイルをドラッグ
2. ドロップゾーンにドロップ
3. プレビューが表示されることを確認
4. メニュー情報を入力して「保存」
5. 画像が自動的にアップロードされることを確認

#### パターン2: ファイル選択
1. 「ファイルを選択」ボタンをクリック
2. ファイル選択ダイアログで画像を選択
3. プレビューが表示されることを確認
4. メニュー情報を入力して「保存」

#### パターン3: 画像の削除
1. プレビュー表示されている画像の「✕」ボタンをクリック
2. プレビューが非表示になることを確認
3. ドロップゾーンが再表示されることを確認

#### パターン4: バリデーション
1. テキストファイル(.txt)をドロップ → エラーメッセージが表示される
2. 大きすぎる画像(2MB超)をドロップ → エラーメッセージが表示される

### 5. 既存の画像の置き換え
1. 画像が設定済みのメニューを編集
2. 新しい画像をアップロード
3. 保存後、古い画像ファイルが削除されていることを確認
   - `static/images/menus/` ディレクトリを確認

## ファイル構成

### バックエンド
- `routers/store.py` - 画像アップロード/削除APIエンドポイント
- `static/images/menus/` - 画像保存ディレクトリ

### フロントエンド
- `templates/store_menus.html` - ドラッグ&ドロップエリアとプレビューHTML
- `static/css/store_menus.css` - 画像アップロードUIのスタイル
- `static/js/store_menus.js` - 画像アップロード処理のJavaScript

### テスト
- `tests/test_menu_image_upload.py` - ユニットテスト

### 依存関係
- `requirements.in` - Pillow追加
- `requirements.txt` - Pillow 10.4.0

## 技術仕様

### 画像処理
- **ライブラリ**: Pillow (PIL)
- **ファイル名**: UUID v4 + 拡張子
- **保存先**: `static/images/menus/`
- **URL形式**: `/static/images/menus/{uuid}.{ext}`

### セキュリティ
- ファイル形式の検証（MIMEタイプとファイル拡張子）
- ファイルサイズの制限（2MB）
- 認証済みユーザーのみアクセス可能
- 自店舗のメニューのみ操作可能

### パフォーマンス
- 古い画像の自動削除でストレージを節約
- UUIDによる一意なファイル名で衝突を回避
- クライアント側でのプレビュー表示（サーバー負荷軽減）

## トラブルシューティング

### 画像がアップロードされない
1. ブラウザのコンソールでエラーを確認
2. ファイル形式が対応しているか確認
3. ファイルサイズが2MB以下か確認
4. 認証トークンが有効か確認

### プレビューが表示されない
1. ブラウザのJavaScriptエラーを確認
2. `setupImageUpload()` が正しく呼ばれているか確認
3. DOM要素のIDが正しいか確認

### 古い画像が削除されない
1. ファイルの書き込み権限を確認
2. サーバーログでエラーを確認
3. 画像ファイルのパスが正しいか確認

## 次のステップ

- [ ] 画像のリサイズ機能（サムネイル生成）
- [ ] 画像の最適化（圧縮）
- [ ] 複数画像のアップロード
- [ ] 画像のクロップ機能
- [ ] CDNへのアップロード対応
