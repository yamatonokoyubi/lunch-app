# 店舗情報管理画面 実装ドキュメント

## 概要

店舗スタッフがWebブラウザから自店舗の情報を確認・編集できる画面を実装しました。ユーザーの役割に応じて表示を動的に切り替え、owner権限を持つユーザーにのみ編集機能を提供します。

## 実装内容

### 1. 作成したファイル

#### テンプレート
- **`templates/store_profile.html`**
  - 店舗情報の表示・編集画面
  - レスポンシブデザイン対応
  - owner権限でのみ編集可能

#### スタイル
- **`static/css/store_profile.css`**
  - 店舗情報画面専用のスタイリング
  - モバイル対応のレスポンシブデザイン
  - フォーム要素、ボタン、メッセージ表示のスタイル

#### JavaScript
- **`static/js/store_profile.js`**
  - 店舗情報の読み込み・表示
  - フォーム送信処理
  - 画像アップロード・削除機能
  - 権限に応じた動的UI制御

#### 静的リソース
- **`static/images/no-image.svg`**
  - 店舗画像が未設定の場合のプレースホルダー画像

### 2. 変更したファイル

#### FastAPIメインアプリケーション
- **`main.py`**
  - `/store/profile` ルートを追加
  - 店舗情報画面をレンダリング

#### ナビゲーションメニュー更新
以下のテンプレートに「店舗情報」リンクを追加:
- `templates/store_dashboard.html`
- `templates/store_orders.html`
- `templates/store_menus.html`
- `templates/store_reports.html`

#### 共通JavaScriptライブラリ
- **`static/js/common.js`**
  - `ApiClient.uploadImage()` メソッドを追加（画像アップロード用）
  - `ApiClient.getCurrentUser()` メソッドを追加（ユーザー情報取得用）
  - グローバル `apiClient` インスタンスを公開

## 機能詳細

### 画面構成

#### 店舗画像セクション
- 店舗の代表画像を表示
- owner権限の場合:
  - 📷 画像を変更ボタン（JPEG, PNG, GIF, WebP対応）
  - 🗑️ 画像を削除ボタン
- 最大ファイルサイズ: 5MB

#### 基本情報セクション
- 店舗名（必須）
- メールアドレス
- 電話番号
- 住所

#### 営業時間セクション
- 開店時間
- 閉店時間

#### 店舗説明セクション
- 説明文（最大1000文字）

#### ステータスセクション
- 営業中/休業中の切り替え

#### メタ情報
- 作成日時
- 最終更新日時

### 権限制御

#### Owner（オーナー）
- ✅ すべての情報を閲覧可能
- ✅ すべての情報を編集可能
- ✅ 画像のアップロード・削除が可能
- ✅ 「変更を保存」ボタンが表示される

#### Manager（マネージャー）/ Staff（スタッフ）
- ✅ すべての情報を閲覧可能
- ❌ 編集不可（すべてのフィールドがdisabled状態）
- ❌ 画像のアップロード・削除ボタンは非表示
- ℹ️ 「この情報はオーナー権限でのみ編集できます」というメッセージが表示される

### API連携

使用するAPIエンドポイント:

| メソッド | エンドポイント | 用途 |
|---------|---------------|------|
| GET | `/api/auth/me` | ユーザー情報取得（権限確認） |
| GET | `/api/store/profile` | 店舗情報取得 |
| PUT | `/api/store/profile` | 店舗情報更新 |
| POST | `/api/store/profile/image` | 店舗画像アップロード |
| DELETE | `/api/store/profile/image` | 店舗画像削除 |

### レスポンシブデザイン

#### デスクトップ（768px以上）
- 2カラムレイアウト（営業時間）
- 大きなフォント・ボタン

#### タブレット（768px未満）
- 1カラムレイアウト
- コンパクトなボタン配置

#### モバイル（480px未満）
- フルスクリーンレイアウト
- タップしやすいボタンサイズ
- iOSのズーム防止（font-size: 16px）

## 使用方法

### アクセス方法

1. 店舗スタッフとしてログイン
2. ナビゲーションメニューから「店舗情報」をクリック
3. または直接 `/store/profile` にアクセス

### 情報の編集（Ownerのみ）

1. 編集したいフィールドに値を入力
2. 「💾 変更を保存」ボタンをクリック
3. 成功メッセージが表示されたら完了

### 画像のアップロード（Ownerのみ）

1. 「📷 画像を変更」ボタンをクリック
2. ファイル選択ダイアログから画像を選択
3. 自動的にアップロードが開始
4. 成功メッセージが表示されたら完了

### 画像の削除（Ownerのみ）

1. 「🗑️ 画像を削除」ボタンをクリック
2. 確認ダイアログで「OK」をクリック
3. 画像が削除され、プレースホルダーが表示される

## セキュリティ

### フロントエンド制御
- ユーザーロールに基づいて編集UIの表示/非表示を制御
- disabled属性でフォーム要素を無効化

### バックエンド制御（既存実装）
- `/api/store/profile` (PUT): `require_role(['owner'])` で保護
- `/api/store/profile/image` (POST): `require_role(['owner'])` で保護
- `/api/store/profile/image` (DELETE): `require_role(['owner'])` で保護

### テナント分離
- ユーザーは自分が所属する店舗の情報のみアクセス可能
- `current_user.store_id` でフィルタリング

## エラーハンドリング

### バリデーション
- 店舗名が空の場合: エラーメッセージ表示
- 説明文が1000文字を超える場合: エラーメッセージ表示
- 不正なファイル形式: エラーメッセージ表示
- ファイルサイズが5MBを超える: エラーメッセージ表示

### API エラー
- 401 Unauthorized: ログイン画面にリダイレクト
- 403 Forbidden: 権限エラーメッセージ表示
- 404 Not Found: 店舗が見つからないエラー表示
- 422 Validation Error: バリデーションエラー表示
- 500 Server Error: サーバーエラーメッセージ表示

## テスト手順

### 1. Owner権限でのテスト

```bash
# 1. Ownerユーザーでログイン
# 2. /store/profile にアクセス
# 3. 確認項目:
#    - すべてのフィールドが編集可能
#    - 「変更を保存」ボタンが表示される
#    - 画像アップロードボタンが表示される
#    - 画像削除ボタンが表示される（画像がある場合）
# 4. 情報を編集して保存
# 5. 成功メッセージが表示されることを確認
# 6. ページをリロードして変更が反映されていることを確認
```

### 2. Manager権限でのテスト

```bash
# 1. Managerユーザーでログイン
# 2. /store/profile にアクセス
# 3. 確認項目:
#    - すべてのフィールドが読み取り専用（disabled）
#    - 「変更を保存」ボタンが表示されない
#    - 画像アップロードボタンが表示されない
#    - 「オーナー権限でのみ編集できます」メッセージが表示される
```

### 3. Staff権限でのテスト

```bash
# 1. Staffユーザーでログイン
# 2. /store/profile にアクセス
# 3. Manager権限と同じ動作を確認
```

### 4. レスポンシブデザインのテスト

```bash
# ブラウザの開発者ツールで以下のデバイスをエミュレート:
# - デスクトップ (1920x1080)
# - タブレット (768x1024)
# - モバイル (375x667 - iPhone SE)
# 
# 確認項目:
# - レイアウトが崩れていないか
# - ボタンがタップしやすいサイズか
# - テキストが読みやすいか
```

## Acceptance Criteria チェックリスト

- ✅ `/store/profile` にアクセスすると、ログイン中のユーザーが所属する店舗の情報が表示される
- ✅ owner権限でログインした場合、情報の編集フォームと保存ボタンが表示され、実際に情報を更新できる
- ✅ manager または staff 権限でログインした場合、情報は表示されるが、編集フォームは表示されず読み取り専用である
- ✅ 作成した画面が、PCとモバイル端末の両方で表示崩れしないレスポンシブデザインである

## 今後の改善案

### 機能追加
- [ ] 営業時間の曜日別設定
- [ ] 複数画像のアップロード（ギャラリー機能）
- [ ] 画像のトリミング・編集機能
- [ ] SNSリンクの追加
- [ ] 地図表示機能

### UX改善
- [ ] ドラッグ&ドロップでの画像アップロード
- [ ] 画像プレビュー機能
- [ ] 入力値の自動保存（下書き機能）
- [ ] 変更履歴の表示

### パフォーマンス
- [ ] 画像の自動リサイズ・最適化
- [ ] 遅延読み込み（Lazy Loading）
- [ ] キャッシュ戦略の最適化

## トラブルシューティング

### 問題: 画像がアップロードできない
**解決策**: 
- ファイル形式を確認（JPEG, PNG, GIF, WebPのみ対応）
- ファイルサイズを確認（5MB以下）
- `static/uploads/stores/` ディレクトリの書き込み権限を確認

### 問題: 保存ボタンが表示されない
**解決策**:
- ユーザーがowner権限を持っているか確認
- ブラウザのコンソールでエラーが出ていないか確認
- ローカルストレージのauthTokenが有効か確認

### 問題: レスポンシブデザインが効かない
**解決策**:
- `<meta name="viewport">` タグが正しく設定されているか確認
- CSSファイルが正しく読み込まれているか確認
- ブラウザのキャッシュをクリア

## 関連ドキュメント

- [店舗プロフィールAPI仕様](STORE_PROFILE_API.md)
- [店舗プロフィールAPIテストレポート](STORE_PROFILE_API_TEST_REPORT.md)
- [ER図](ER_DIAGRAM.md)

---

**実装日**: 2025年10月11日  
**実装者**: GitHub Copilot  
**バージョン**: 1.0.0
